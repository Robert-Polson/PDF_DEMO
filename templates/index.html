<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>Сжатие PDF</title>
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css"/>
<style>
  body {
    padding: 2rem;
}
#drop-zone {
    border: 2px dashed #ccc;
    padding: 2rem;
    text-align: center;
    cursor: pointer;
    transition: background-color 0.3s;
}
#drop-zone:hover {
    background-color: #f2f6fd;
}
#upload-btn{
  transition: background-color 0.3s;
}
#compression-level{
  transition:  0.3s;
}
</style>
</head>

<body class="container my-3">

<h1>Сжать PDF файл</h1>

<!--Зона выбора файла-->
<div id="drop-zone" class="mb-3">
  <p>Перетащите файл или кликните для выбора</p>
  <input type="file" id="file-input" accept=".pdf" style="display:none"/>
</div>

<!--Выбор уровня сжатия-->
<div class="mb-3">
<label for="compression-level" class="form-label">Уровень сжатия:</label>
<select id="compression-level" class="form-select">
<option value="low">Низкий</option>
<option value="medium" selected>Средний</option>
<option value="high">Высокий</option>
</select>
</div>

<!--Кнопка отправки-->
<button id="upload-btn" class="btn btn-primary">Сжать и скачать</button>

<!--Прогресс бар-->
<div id="progress-container" class="mt-4" style="display:none;">
  <div class="progress">
    <div id="progress-bar" class="progress-bar progress-bar-striped progress-bar-animated" role="progressbar" style="width: 0%" aria-valuenow="0" aria-valuemin="0" aria-valuemax="100">Обработка...</div>
  </div>
</div>

<!--Статус сообщений-->
<div id="status-message" class="mt-3"></div>

<script>
//Присвоение элеметов
const dropZone = document.getElementById('drop-zone');
const fileInput = document.getElementById('file-input');
const uploadBtn = document.getElementById('upload-btn');
const statusMessage = document.getElementById('status-message');
const progressContainer = document.getElementById('progress-container');
const progressBar = document.getElementById('progress-bar');

//Снятие фокуса(синей рамки) после выбора уровня сжатия в меню
document.getElementById('compression-level').addEventListener('change', function() {
    this.blur();
});

let selectedFile = null;

//Клик по выбору файал
dropZone.addEventListener('click', () => {
    fileInput.click();
});

//Статус файла
fileInput.addEventListener('change', () => {
    if (fileInput.files.length > 0) {
        selectedFile = fileInput.files[0];
        statusMessage.innerHTML = `<p>Выбран файл: ${selectedFile.name}</p>`;
        resetProgress();
    }
});

//Перетаскивание в зону погрузки
dropZone.addEventListener('dragover', (e) => {
    e.preventDefault();
    dropZone.classList.add('hover');
});
dropZone.addEventListener('dragleave', () => {
    dropZone.classList.remove('hover');
});
dropZone.addEventListener('drop', (e) => {
    e.preventDefault();
    dropZone.classList.remove('hover');
    if (e.dataTransfer.files.length > 0) {
        selectedFile = e.dataTransfer.files[0];
        statusMessage.innerHTML = `<p>Выбран файл: ${selectedFile.name}</p>`;
        resetProgress();
    }
});

//Сброс прогресс-бара
function resetProgress() {
    progressContainer.style.display = 'none';
    progressBar.style.width = '0%';
    progressBar.setAttribute('aria-valuenow', '0');
}

//Обновление прогресс-бара
function updateProgress(percent) {
  progressBar.style.width = percent + '%';
  progressBar.setAttribute('aria-valuenow', percent);
}

//Клик по кнопке Сжать
uploadBtn.addEventListener('click', () => {
    if (!selectedFile) {
        alert("Пожалуйста, выберите PDF-файл");
        return;
    }
    //Передаём всё(уровень сжатия, имя файла) и задаём константы
    const levelSelect = document.getElementById('compression-level');
    const level = levelSelect.value;
    const original_filename = selectedFile.name;
    const formData = new FormData();
    formData.append('file', selectedFile);
    formData.append('level', level);
    formData.append('original_filename', selectedFile.name);
    const xhr = new XMLHttpRequest();

    xhr.open('POST', '/compress');

    //Обновление прогресс-бара при отправке данных
    xhr.upload.onprogress = (event) => {
        if (event.lengthComputable) {
            const percentComplete = Math.round((event.loaded / event.total) * 100);
            updateProgress(percentComplete);
        }
    };
    //Загрузка
    xhr.onload = () => {
        if (xhr.status === 200) {
            const blob = xhr.response;
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = 'СЖАТЫЙ_' + level + '_' + original_filename;//!!!!получаем файл(original_filename - это константа с именем файла строка: 134, LEVEL - уровень сжатия)!!!!
            document.body.appendChild(a);
            a.click();
            a.remove();
            window.URL.revokeObjectURL(url);
            statusMessage.innerHTML=`<p>Файл успешно сжат и скачан!</p>`;
        } else {
            alert(`Ошибка сервера: ${xhr.statusText}`);
            statusMessage.innerHTML=`<p style='color:red;'>Ошибка при сжатии файла.</p>`;
        }
        progressContainer.style.display='none';
        resetProgress();
    };
    //Ошибки
    xhr.onerror=()=>{
        alert("Произошла ошибка при отправке запроса");
        statusMessage.innerHTML=`<p style='color:red;'>Ошибка сети.</p>`;
        resetProgress();
        progressContainer.style.display='none';
    };

xhr.responseType='blob';
progressContainer.style.display='block';
xhr.send(formData);
});
</script>

</body>
</html>